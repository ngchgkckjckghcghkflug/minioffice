name: Build LO

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual triggering

jobs:
  build:
    runs-on: ubuntu-24.04 
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Show available space
      run: |
        ls
        df -h  # Show available space
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        
        # Method 2: Manual dependency installation (fallback)
        echo "Installing manual dependencies..."
        sudo apt-get install git build-essential zip ccache junit4 libkrb5-dev nasm graphviz python3 python3-dev python3-setuptools qtbase5-dev libkf5coreaddons-dev libkf5i18n-dev libkf5config-dev libkf5windowsystem-dev libkf5kio-dev libqt5x11extras5-dev autoconf libcups2-dev libfontconfig1-dev gperf openjdk-17-jdk doxygen libxslt1-dev xsltproc libxml2-utils libxrandr-dev libx11-dev bison flex libgtk-3-dev libgstreamer-plugins-base1.0-dev libgstreamer1.0-dev ant ant-optional libnss3-dev libavahi-client-dev libxt-dev meson
    - name: Setup ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: libreoffice-build
        max-size: 2G
        
    - name: Clone LibreOffice
      run: |
        git clone --depth 1  -b libreoffice-7-4-1 --single-branch https://github.com/LibreOffice/core.git libreoffice
        cd libreoffice
        ######## test ####
    - name: Configure LibreOffice build
      run: |
        cd libreoffice
        echo "=== Starting regular configuration ==="
        ./autogen.sh --disable-gtk3 --disable-gen --disable-gui --without-x --without-java --with-theme=no \
          --disable-dynamic-loading --enable-customtarget-components --with-parallelism="yes" --disable-option-checking --best-effort 
        
        
        make help
    - name: Build LibreOffice
      run: |
        cd libreoffice
        make 
        
    - name: Package LibreOffice installation
      run: |
        cd libreoffice
        
        # Create complete package
        mkdir -p libreoffice-build
        
        # Copy the full installation
        if [ -d "instdir" ]; then
          echo "Copying full LibreOffice installation..."
          cp -r instdir/* libreoffice-build/
        else
          echo "ERROR: Could not find instdir"
          exit 1
        fi
        
        # Create archive
        echo "=== Creating archive ==="
        tar -czf libreoffice-build.tar.gz libreoffice-build/
        
        # Show final sizes
        echo "=== Final package size ==="
        ls -lh libreoffice-build.tar.gz
        sha256sum libreoffice-build.tar.gz
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: minimal-libreoffice
        path: libreoffice/libreoffice-build.tar.gz
        retention-days: 30
        
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
