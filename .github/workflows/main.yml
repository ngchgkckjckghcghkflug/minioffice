name: Build LO

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual triggering

jobs:
  build:
    runs-on: ubuntu-24.04 
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Show available space
      run: |
        ls
        df -h  # Show available space
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        
        # Method 2: Manual dependency installation (fallback)
        echo "Installing manual dependencies..."
        sudo apt-get install git build-essential zip ccache junit4 libkrb5-dev nasm graphviz python3 python3-dev python3-setuptools qtbase5-dev libkf5coreaddons-dev libkf5i18n-dev libkf5config-dev libkf5windowsystem-dev libkf5kio-dev libqt5x11extras5-dev autoconf libcups2-dev libfontconfig1-dev gperf openjdk-17-jdk doxygen libxslt1-dev xsltproc libxml2-utils libxrandr-dev libx11-dev bison flex libgtk-3-dev libgstreamer-plugins-base1.0-dev libgstreamer1.0-dev ant ant-optional libnss3-dev libavahi-client-dev libxt-dev meson
    - name: Setup ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: libreoffice-build
        max-size: 2G
        
    - name: Clone LibreOffice
      run: |
        git clone --depth 1  -b libreoffice-25-8-3 --single-branch https://github.com/LibreOffice/core.git libreoffice
        cd libreoffice
        ######## test ####
    - name: Configure LibreOffice build
      run: |
        echo "=== Starting regular configuration ==="
        git clone https://github.com/emscripten-core/emsdk.git
        cd emsdk
        git pull
        ./emsdk install 3.1.46
        ./emsdk activate 3.1.46
        cd ..
        cat > configure-build.sh << 'EOF'
        #!/bin/bash
        # Regular LibreOffice build with minimal changes
        export CXXFLAGS=" -ffunction-sections -fdata-sections" \
        export CFLAGS=" -ffunction-sections -fdata-sections" \
        export LDFLAGS="-Wl,--gc-sections -s"

        
        source ./emsdk/emsdk_env.sh
        cd libreoffice
        echo "=== Starting regular configuration ==="
        ./autogen.sh --disable-debug --enable-sal-log --disable-crashdump --host=wasm32-local-emscripten --disable-gui --with-wasm-module=writer --with-package-format=emscripten  --without-java --with-parallelism='yes' --enable-lto
        EOF
        chmod +x configure-build.sh
        ./configure-build.sh
    - name: Build LibreOffice
      id: build
      run: |
        cd libreoffice
        make || echo "BUILD_FAIL=true" >> "$GITHUB_OUTPUT"
        
    - name: Package LibreOffice installation
      run: |
        cd libreoffice
        export BUILD_FAIL="${{ steps.build.outputs.BUILD_FAIL }}"
        # Create complete package
        mkdir -p libreoffice-build
        
        # if the build does not fail send instdir
        if [-z "$BUILD_FAIL"]; then
          echo "Copying full LibreOffice installation..."
          cp -r instdir/* libreoffice-build/
        else
          if [ -n "$BUILD_FAIL" ]; then
              # Run if build fails
              echo "Build failed. Exporting workdir"
              cp -r workdir libreoffice-build/
          fi
        fi
        
        # Create archive
        echo "=== Creating archive ==="
        tar -czf libreoffice-build.tar.gz libreoffice-build/
        
        # Show final sizes
        echo "=== Final package size ==="
        ls -lh libreoffice-build.tar.gz
        sha256sum libreoffice-build.tar.gz
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.build.outputs.BUILD_FAIL == 'true' && format('failed-{0}', 'build') || format('lo-{0}', 'build') }}
        path: libreoffice/libreoffice-build.tar.gz
        retention-days: 30
        
    - name: Represent true status
      run: |
        [ steps.build.outputs.BUILD_FAIL == 'true' ] && { exit 1; }
  
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
