name: Build LO

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual triggering

jobs:
  build:
    runs-on: ubuntu-24.04 
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Show available space
      run: |
        df -h  # Show available space
        
    - name: Install dependencies
      run: |
        sudo apt-get update
  
        sudo apt-get build-dep -y libreoffice || true
        
        # Method 2: Manual dependency installation (fallback)
        echo "Installing manual dependencies..."
        sudo apt-get install git build-essential zip ccache junit4 libkrb5-dev nasm graphviz python3 python3-dev python3-setuptools qtbase5-dev libkf5coreaddons-dev libkf5i18n-dev libkf5config-dev libkf5windowsystem-dev libkf5kio-dev libqt5x11extras5-dev autoconf libcups2-dev libfontconfig1-dev gperf openjdk-17-jdk doxygen libxslt1-dev xsltproc libxml2-utils libxrandr-dev libx11-dev bison flex libgtk-3-dev libgstreamer-plugins-base1.0-dev libgstreamer1.0-dev ant ant-optional libnss3-dev libavahi-client-dev libxt-dev meson
    - name: Setup ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: libreoffice-build
        max-size: 2G
        
    - name: Clone LibreOffice
      run: |
        git clone --depth 1  -b libreoffice-7-6-7 --single-branch https://github.com/LibreOffice/core.git libreoffice
        cd libreoffice
        ######## test ####
    - name: Configure LibreOffice build
      run: |
        cd libreoffice
        
        echo "=== Starting regular configuration ==="
        cat > configure-build.sh << 'EOF'
        #!/bin/bash
        #LibreOffice build with changes
        export CFLAGS="-ffunction-sections -fdata-sections"
        ./autogen.sh \
             --without-x --without-java --with-theme=no --enable-optimized=yes --enable-lto
        EOF
        chmod +x configure-build.sh
        ./configure-build.sh
        
    - name: Build LibreOffice
      run: |
        cd libreoffice
        make
        
    - name: Package LibreOffice installation
      run: |
        cd libreoffice
        
        # Check what was actually built
        echo "=== Checking build output ==="
        find . -name "soffice*" -type f | head -10
        ls -la instdir/ || echo "No instdir found"
        
        # Create complete package
        mkdir -p libreoffice-build
        
        # Copy the full installation
        if [ -d "instdir" ]; then
          echo "Copying full LibreOffice installation..."
          cp -r instdir/* libreoffice-build/
        else
          echo "ERROR: Could not find instdir"
          exit 1
        fi
        
        # Create conversion script for convenience
        cat > libreoffice-build/convert.sh << 'EOF'
        #!/bin/bash
        SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
        export LD_LIBRARY_PATH="$SCRIPT_DIR/program:$LD_LIBRARY_PATH"
        
        if [ $# -lt 2 ]; then
          echo "Usage: $0 <input_file> <output_directory>"
          echo "Converts documents using LibreOffice headless mode"
          exit 1
        fi
        
        INPUT_FILE="$1"
        OUTPUT_DIR="$2"
        
        # Validate input
        if [ ! -f "$INPUT_FILE" ]; then
          echo "Error: Input file '$INPUT_FILE' not found"
          exit 1
        fi
        
        if [ ! -d "$OUTPUT_DIR" ]; then
          mkdir -p "$OUTPUT_DIR" || {
            echo "Error: Cannot create output directory '$OUTPUT_DIR'"
            exit 1
          }
        fi
        
        # Convert with headless mode
        "$SCRIPT_DIR/program/soffice" \
          --headless \
          --convert-to pdf \
          --outdir "$OUTPUT_DIR" \
          "$INPUT_FILE"
        EOF
        chmod +x libreoffice-build/convert.sh
        
        # Create archive
        echo "=== Creating archive ==="
        tar -czf libreoffice-build.tar.gz libreoffice-build/
        
        # Show final sizes
        echo "=== Final package size ==="
        ls -lh libreoffice-build.tar.gz
        du -sh libreoffice-build/
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: minimal-libreoffice
        path: libreoffice/libreoffice-build.tar.gz
        retention-days: 30
        
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
