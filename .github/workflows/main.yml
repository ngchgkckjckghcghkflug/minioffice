name: Build LO

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual triggering

jobs:
  build:
    runs-on: ubuntu-24.04 
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Show available space
      run: |
        ls
        df -h  # Show available space
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        
        # Method 2: Manual dependency installation (fallback)
        echo "Installing manual dependencies..."
        sudo apt-get install git build-essential zip ccache junit4 libkrb5-dev nasm graphviz python3 python3-dev python3-setuptools qtbase5-dev libkf5coreaddons-dev libkf5i18n-dev libkf5config-dev libkf5windowsystem-dev libkf5kio-dev libqt5x11extras5-dev autoconf libcups2-dev libfontconfig1-dev gperf openjdk-17-jdk doxygen libxslt1-dev xsltproc libxml2-utils libxrandr-dev libx11-dev bison flex libgtk-3-dev libgstreamer-plugins-base1.0-dev libgstreamer1.0-dev ant ant-optional libnss3-dev libavahi-client-dev libxt-dev meson
    - name: Setup ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: libreoffice-build
        max-size: 2G
        
    - name: Clone LibreOffice
      run: |
        git clone --depth 1  -b libreoffice-25-8-3 --single-branch https://github.com/LibreOffice/core.git libreoffice
        cd libreoffice
        ######## test ####
    - name: Configure LibreOffice build
      run: |
        echo "=== Starting regular configuration ==="
        git clone https://github.com/emscripten-core/emsdk.git
        cd emsdk
        git pull
        ./emsdk install 3.1.46
        ./emsdk activate 3.1.46
        cd ..
        cat > configure-build.sh << 'EOF'
        #!/bin/bash
        # Regular LibreOffice build with minimal changes
        export CC="emcc -pthread -s USE_PTHREADS=1 -fwasm-exceptions -s SUPPORT_LONGJMP=wasm -mbulk-memory -msimd128 -msse4.2 -msse4.1 -mssse3 -msse3 -msse2 -msse"
        export CXX="em++ -pthread -s USE_PTHREADS=1 -fwasm-exceptions -s SUPPORT_LONGJMP=wasm -mbulk-memory -msimd128 -msse4.2 -msse4.1 -mssse3 -msse3 -msse2 -msse"

        
        source ./emsdk/emsdk_env.sh

        
        cd libreoffice

        echo "=== Starting regular configuration ==="
        ./autogen.sh --host=wasm32-local-emscripten --enable-mpl-subset --with-vendor=Macro --disable-community-flavor --disable-poppler --enable-cairo-rgba --without-java --without-junit --without-help --with-galleries=no --disable-dbus --disable-odk --disable-kf5 --disable-gtk3 --disable-qt5 --disable-gstreamer-1-0 --disable-evolution2 --disable-gio --disable-gui --disable-scripting --disable-ext-wiki-publisher --disable-report-builder --disable-ext-nlpsolver --disable-sdremote --disable-sdremote-bluetooth --disable-postgresql-sdbc --disable-firebird-sdbc --disable-randr --disable-ext-numbertext --disable-online-update --disable-dconf --enable-release-build --disable-lotuswordpro --disable-lpsolve --without-templates --enable-sal-log --disable-debug --disable-crashdump --with-main-module=writer --enable-ccache --with-build-platform-configure-options=--enable-ccache --enable-wasm-exceptions --with-fonts --with-lang=en-US --without-gssapi --without-krb5 
        EOF
        chmod +x configure-build.sh
        ./configure-build.sh
    - name: Build LibreOffice
      id: build
      run: |
        cd libreoffice
        make


    - name: Upload Workdir
      if: failure() && steps.build.outcome == 'failure'
      run: |
        cd libreoffice
        # make folder
        mkdir -p libreoffice-build
        
        echo "Copying workdir ..."
        cp -r workdir libreoffice-build/
        
        # Create archive
        echo "=== Creating archive ==="
        tar -czf libreoffice-build.tar.gz libreoffice-build/
        
        # Show final sizes
        echo "=== Final package size ==="
        ls -lh libreoffice-build.tar.gz
        sha256sum libreoffice-build.tar.gz
        
    - name: Package LibreOffice installation
      if: success()
      run: |
        cd libreoffice
        # Create complete package
        mkdir -p libreoffice-build
        
        echo "Copying full LibreOffice installation..."
        cp -r instdir/* libreoffice-build/
        
        # Create archive
        echo "=== Creating archive ==="
        tar -czf libreoffice-build.tar.gz libreoffice-build/
        
        # Show final sizes
        echo "=== Final package size ==="
        ls -lh libreoffice-build.tar.gz
        sha256sum libreoffice-build.tar.gz
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      if: ${{ !cancelled() }}
      with:
        name: ${{ steps.build.outcome == 'failure' && format('failed-{0}', 'build') || format('lo-{0}', 'build') }}
        path: libreoffice/libreoffice-build.tar.gz
        retention-days: 30
        
  
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
